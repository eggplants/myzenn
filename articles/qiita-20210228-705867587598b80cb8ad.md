---
title: "ç›´è¿‘ä¸€é€±é–“ã®æ—¥æœ¬åœ°éœ‡XMLã‚’jqã§å‡¦ç†ã—ã¦CSVã«ã™ã‚‹"
emoji: "ğŸ˜€"
type: "tech"
topics: [Bash,XML,jq]
published: true
---
## ä½•ï¼Ÿ

NHKã®åœ°éœ‡æƒ…å ±API(XMLå½¢å¼)ã‚’jqã§CSVã«å¤‰æ›ã—æ›¸ãå‡ºã™.
ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨€èªã§æ›¸ãã‚ˆã‚Šã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§jqã‚’ä½¿ã†ã¨ã‚·ãƒ¥ãƒƒã¨çµ‚ã‚ã‚‹ã®ã§ãŠã™ã™ã‚.
æ›¸ãå‡ºã—ãŸCSVã¯Excelã§å‡¦ç†ã™ã‚‹ãªã‚ŠPythonã«é£Ÿã‚ã›ã‚‹ãªã‚Šã§ãã‚‹.

## API

- <https://www3.nhk.or.jp/sokuho/jishin/data/JishinReport.xml>

ç´ ã®ã¾ã¾ã ã¨Shift-JISãªã®ã§æ‰±ã„ã‚„ã™ã„UTF-8ã«å¤‰æ›ã™ã‚‹.

```bash
$ curl -s https://www3.nhk.or.jp/sokuho/jishin/data/JishinReport.xml \
  | iconv -f sjis -t utf8
```

```xml:JishinReport.xml
<?xml version="1.0" encoding="UTF-8"?>
<jishinReport>
   <record date="2021å¹´02æœˆ28æ—¥">
      <item time="13æ™‚14åˆ†ã”ã‚" shindo="1" url="https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210228131405_20210228131703.xml">åƒè‘‰çœŒæ±æ–¹æ²–</item>
      <item time="11æ™‚20åˆ†ã”ã‚" shindo="2" url="https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210228112012_20210228112403.xml">å¤§é˜ªåºœåŒ—éƒ¨</item>
      <item time="09æ™‚40åˆ†ã”ã‚" shindo="2" url="https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210228094024_20210228094308.xml">å³¶æ ¹çœŒæ±éƒ¨</item>
   </record>
...(çœç•¥)...
   <record date="2021å¹´02æœˆ22æ—¥">
      <item time="11æ™‚57åˆ†ã”ã‚" shindo="3" url="https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210222115717_20210222120040.xml">å’Œæ­Œå±±çœŒåŒ—éƒ¨</item>
      <item time="11æ™‚23åˆ†ã”ã‚" shindo="1" url="https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210222112327_20210222112619.xml">ç¦å³¶çœŒæ²–</item>
      <item time="10æ™‚56åˆ†ã”ã‚" shindo="3" url="https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210222105604_20210222110001.xml">æ ¹å®¤åŠå³¶å—æ±æ²–</item>
   </record>
</jishinReport>
```

## CSVã«ã™ã‚‹

### `xq`ã®å°å…¥

- [kislyuk/yq: Command-line YAML, XML, TOML processor - jq wrapper for YAML/XML/TOML documents](https://github.com/kislyuk/yq)

ã¾ãšXMLã‚’JSONãƒ‘ãƒ¼ã‚µã§ã‚ã‚‹jqã§æ‰±ã†ã«ã¯ã€jqã®XMLãƒ©ãƒƒãƒ‘ãƒ¼`xq`ã‚’ç”¨ã„ã‚‹.
`xq`ã¯YAMLãƒ©ãƒƒãƒ‘ãƒ¼ã§ã‚ã‚‹`yq`ã«å«ã¾ã‚Œã‚‹.

```bash
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ pip install yq
```

### ãƒ‘ãƒ¼ã‚¹

å„ã‚«ãƒ©ãƒ ã¯`date,time,place,shindo,datasource`
`jq`ã¯å„ãƒ‡ãƒ¼ã‚¿ã‚’`[head1, ..., h5], [[col1, ..., c5], [c1, ..., c5], ...][]|@csv`ã¨ã™ã‚‹ã¨ãƒ˜ãƒƒãƒ€ä»˜ãCSVã‚’æ›¸ãå‡ºã›ã‚‹.


```bash
$ curl -s https://www3.nhk.or.jp/sokuho/jishin/data/JishinReport.xml \
  | iconv -f sjis -t utf8 \
  | xq -r '
    [
      "date",
      "time",
      "place",
      "shindo",
      "datasource"
    ],
    (
      [                     
        .jishinReport.record[]
        | ."@date" as $i | .item
        | if type=="object" then [.] else . end
        | map(.+={"@date":$i})[]
        | [
          ."@date",
          ."@time",
          ."#text",
          "éœ‡åº¦"+."@shindo",
          ."@url"
        ]
      ] | reverse
    )[] | @csv'  > res.csv
```

```csv:res.csv
"date","time","place","shindo","datasource"
"2021å¹´02æœˆ22æ—¥","10æ™‚56åˆ†ã”ã‚","æ ¹å®¤åŠå³¶å—æ±æ²–","éœ‡åº¦3","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210222105604_20210222110001.xml"
"2021å¹´02æœˆ22æ—¥","11æ™‚23åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210222112327_20210222112619.xml"
"2021å¹´02æœˆ22æ—¥","11æ™‚57åˆ†ã”ã‚","å’Œæ­Œå±±çœŒåŒ—éƒ¨","éœ‡åº¦3","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210222115717_20210222120040.xml"
"2021å¹´02æœˆ23æ—¥","04æ™‚42åˆ†ã”ã‚","èŒ¨åŸçœŒåŒ—éƒ¨","éœ‡åº¦2","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210223044248_20210223044539.xml"
"2021å¹´02æœˆ23æ—¥","06æ™‚22åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦2","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210223062244_20210223062534.xml"
"2021å¹´02æœˆ23æ—¥","06æ™‚40åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210223064051_20210223064339.xml"
"2021å¹´02æœˆ23æ—¥","07æ™‚05åˆ†ã”ã‚","é•·é‡çœŒåŒ—éƒ¨","éœ‡åº¦2","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210223070550_20210223070820.xml"
"2021å¹´02æœˆ23æ—¥","09æ™‚36åˆ†ã”ã‚","ç´€ä¼Šæ°´é“","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210223093601_20210223093846.xml"
"2021å¹´02æœˆ23æ—¥","09æ™‚52åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210223095217_20210223095523.xml"
"2021å¹´02æœˆ23æ—¥","16æ™‚09åˆ†ã”ã‚","ä¼Šäºˆç˜","éœ‡åº¦3","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210223160907_20210223161234.xml"
"2021å¹´02æœˆ24æ—¥","00æ™‚56åˆ†ã”ã‚","èŒ¨åŸçœŒå—éƒ¨","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210224005613_20210224005907.xml"
"2021å¹´02æœˆ24æ—¥","02æ™‚39åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210224023905_20210224024140.xml"
"2021å¹´02æœˆ24æ—¥","08æ™‚35åˆ†ã”ã‚","é¹¿å…å³¶çœŒè–©æ‘©åœ°æ–¹","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210224083552_20210224083907.xml"
"2021å¹´02æœˆ24æ—¥","09æ™‚54åˆ†ã”ã‚","åƒè‘‰çœŒå—éƒ¨","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210224095431_20210224095703.xml"
"2021å¹´02æœˆ25æ—¥","01æ™‚12åˆ†ã”ã‚","åºƒå³¶çœŒåŒ—éƒ¨","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210225011229_20210225011523.xml"
"2021å¹´02æœˆ25æ—¥","07æ™‚26åˆ†ã”ã‚","æŠæ‰å³¶ä»˜è¿‘","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210225072646_20210225073009.xml"
"2021å¹´02æœˆ25æ—¥","15æ™‚55åˆ†ã”ã‚","ç†Šæœ¬çœŒç†Šæœ¬åœ°æ–¹","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210225155514_20210225155813.xml"
"2021å¹´02æœˆ25æ—¥","19æ™‚18åˆ†ã”ã‚","åƒè‘‰çœŒåŒ—æ±éƒ¨","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210225191851_20210225192120.xml"
"2021å¹´02æœˆ25æ—¥","22æ™‚57åˆ†ã”ã‚","å’Œæ­Œå±±çœŒåŒ—éƒ¨","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210225225753_20210225230139.xml"
"2021å¹´02æœˆ26æ—¥","04æ™‚45åˆ†ã”ã‚","ç§‹ç”°çœŒæ²–","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210226044543_20210226044843.xml"
"2021å¹´02æœˆ26æ—¥","07æ™‚13åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210226071317_20210226071639.xml"
"2021å¹´02æœˆ26æ—¥","10æ™‚16åˆ†ã”ã‚","å’Œæ­Œå±±çœŒåŒ—éƒ¨","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210226101617_20210226101925.xml"
"2021å¹´02æœˆ26æ—¥","13æ™‚04åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦2","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210226130433_20210226130732.xml"
"2021å¹´02æœˆ26æ—¥","14æ™‚03åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦2","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210226140313_20210226140553.xml"
"2021å¹´02æœˆ26æ—¥","18æ™‚42åˆ†ã”ã‚","å¤§åˆ†çœŒä¸­éƒ¨","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210226184229_20210226184543.xml"
"2021å¹´02æœˆ26æ—¥","19æ™‚18åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦2","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210226191838_20210226192148.xml"
"2021å¹´02æœˆ26æ—¥","20æ™‚31åˆ†ã”ã‚","é’æ£®çœŒæ±æ–¹æ²–","éœ‡åº¦3","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210226203145_20210226203448.xml"
"2021å¹´02æœˆ27æ—¥","00æ™‚33åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦3","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210227003337_20210227003720.xml"
"2021å¹´02æœˆ27æ—¥","02æ™‚04åˆ†ã”ã‚","ç¦å³¶çœŒæ²–","éœ‡åº¦3","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210227020358_20210227020800.xml"
"2021å¹´02æœˆ27æ—¥","05æ™‚48åˆ†ã”ã‚","ãƒˆã‚«ãƒ©åˆ—å³¶è¿‘æµ·","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210227054846_20210227055307.xml"
"2021å¹´02æœˆ27æ—¥","06æ™‚01åˆ†ã”ã‚","ãƒˆã‚«ãƒ©åˆ—å³¶è¿‘æµ·","éœ‡åº¦3","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210227060107_20210227060456.xml"
"2021å¹´02æœˆ27æ—¥","06æ™‚12åˆ†ã”ã‚","ãƒˆã‚«ãƒ©åˆ—å³¶è¿‘æµ·","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210227061230_20210227061618.xml"
"2021å¹´02æœˆ27æ—¥","10æ™‚37åˆ†ã”ã‚","åŸ¼ç‰çœŒå—éƒ¨","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210227103729_20210227104020.xml"
"2021å¹´02æœˆ28æ—¥","09æ™‚40åˆ†ã”ã‚","å³¶æ ¹çœŒæ±éƒ¨","éœ‡åº¦2","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210228094024_20210228094308.xml"
"2021å¹´02æœˆ28æ—¥","11æ™‚20åˆ†ã”ã‚","å¤§é˜ªåºœåŒ—éƒ¨","éœ‡åº¦2","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210228112012_20210228112403.xml"
"2021å¹´02æœˆ28æ—¥","13æ™‚14åˆ†ã”ã‚","åƒè‘‰çœŒæ±æ–¹æ²–","éœ‡åº¦1","https://www3.nhk.or.jp/sokuho/jishin/data/JSA0210228131405_20210228131703.xml"
```

## çµè«–

ãŠæ‰‹è»½

